---
const RAW_BASE = import.meta.env.BASE_URL;

function withBase(path: string = ""): string {
  const b = RAW_BASE.endsWith("/") ? RAW_BASE.slice(0, -1) : RAW_BASE; // "/personalsite"
  const p = path ? (path.startsWith("/") ? path : `/${path}`) : "/";    // "/projects" or "/"
  return `${b}${p}`;                                                    // "/personalsite/projects" or "/personalsite/"
}

const links: { href: string; label: string }[] = [
  { href: withBase(""),         label: "home" },
  { href: withBase("projects"), label: "my projects" },
  { href: withBase("logbook"),  label: "logbook" },
  { href: withBase("blog"),     label: "blog" },
  { href: withBase("jumpscares"), label: "jumpscares" },
];
---

<header class="topbar">
  <nav class="tabs">
    {links.map((l) => (
      <a href={l.href} class="tab">{l.label}</a>
    ))}
  </nav>
  <button id="toggleTheme" class="invert-btn" aria-pressed="false" aria-label="Invert site">invert</button>
</header>

<script is:inline>
(function () {
  var btn  = document.getElementById('toggleTheme');
  if (!btn) return;

  var root = document.documentElement;
  var KEY  = 'theme';
  var PREV = 'prev-theme';

  var saved = localStorage.getItem(KEY);
  if (saved === 'light' || saved === 'dark' || saved === 'spooky') {
    root.setAttribute('data-theme', saved);
  }

  function spawnGhosts(count){
    try {
      if (window.matchMedia && matchMedia('(prefers-reduced-motion: reduce)').matches) return;
    } catch(e){}

    var layer = document.querySelector('.ghosts-layer');
    if (!layer){
      layer = document.createElement('div');
      layer.className = 'ghosts-layer';
      document.body.appendChild(layer);
    }

    var W = window.innerWidth, H = window.innerHeight;
    var ghosts = [];

    for (var i=0; i<count; i++){
      var g = document.createElement('div');
      g.className = 'ghost';
      var size = 26 + Math.random()*42;     // 26â€“68px
      g.style.width  = size + 'px';
      g.style.height = size + 'px';
      g.style.left   = Math.random()*(W - size) + 'px';
      g.style.top    = Math.random()*(H - size) + 'px';

      layer.appendChild(g);

      ghosts.push({
        el: g,
        x: parseFloat(g.style.left),
        y: parseFloat(g.style.top),
        vx: (Math.random()<.5?-1:1) * (0.6 + Math.random()*1.3), // px/frame
        vy: (Math.random()<.5?-1:1) * (0.6 + Math.random()*1.3)
      });
    }

    var raf = 0;
    function frame(){
      W = window.innerWidth; H = window.innerHeight;
      for (var j=0; j<ghosts.length; j++){
        var it = ghosts[j];
        var w = it.el.offsetWidth, h = it.el.offsetHeight;

        it.x += it.vx; it.y += it.vy;
        if (it.x <= 0 || it.x + w >= W) it.vx *= -1;
        if (it.y <= 0 || it.y + h >= H) it.vy *= -1;

        it.el.style.left = Math.max(0, Math.min(W - w, it.x)) + 'px';
        it.el.style.top  = Math.max(0, Math.min(H - h, it.y)) + 'px';
      }
      raf = requestAnimationFrame(frame);
    }
    function start(){ if (!raf) raf = requestAnimationFrame(frame); }
    function stop(){ if (raf){ cancelAnimationFrame(raf); raf = 0; } }

    layer._ghostStop = stop;
    start();

    window.addEventListener('resize', function(){ W = innerWidth; H = innerHeight; });
  }

  function removeGhosts(){
    var layer = document.querySelector('.ghosts-layer');
    if (!layer) return;
    try { layer._ghostStop && layer._ghostStop(); } catch(e){}
    layer.remove();
  }

  btn.setAttribute('aria-pressed', String(root.getAttribute('data-theme') === 'spooky'));

  if ((root.getAttribute('data-theme') || 'dark') === 'spooky') {
    spawnGhosts(6); 
  }

  btn.addEventListener('click', function(){
    var cur = root.getAttribute('data-theme') || 'dark';

    if (cur === 'spooky') {
      var prev = localStorage.getItem(PREV) || 'dark';
      root.setAttribute('data-theme', prev);
      localStorage.setItem(KEY, prev);
      btn.setAttribute('aria-pressed', 'false');
      removeGhosts();
    } else {
      localStorage.setItem(PREV, cur);
      root.setAttribute('data-theme', 'spooky');
      localStorage.setItem(KEY, 'spooky');
      btn.setAttribute('aria-pressed', 'true');
      spawnGhosts(6);
    }
  });
})();
</script>
